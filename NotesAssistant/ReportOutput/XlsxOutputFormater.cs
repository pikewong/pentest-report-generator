using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using NotesAssistant.Findings;
using Excel = Microsoft.Office.Interop.Excel;

namespace NotesAssistant.ReportOutput {

    enum FindingListItemOrder { 
        ITEMNUM = 1,
        APPLICATIONNAME = 2,
        FINDINGNAME = 3,
        GENERALNAME = 4,
        OWASP = 5,
        RISKLEVEL = 6,
        AFFECTED = 7,
        DESCRIPTION = 8,
        RECOMMENDATION = 9,
        NOTES = 10
    }

    class XlsxOutputFormater {
        Excel.Application excelApp = null;
        Excel.Workbook Wb = null;
        Excel.Worksheet Ws = null;
        int numOfItems = 2;

        /*
         * Constructor
         * Initialize Worksheet
         * 
         * */
        public XlsxOutputFormater() {
            excelApp = new Excel.Application();
            excelApp.Visible = true;
            Wb = excelApp.Workbooks.Add();
            Ws = (Excel.Worksheet)excelApp.Worksheets[1];
            initExcelFormat(Ws);
        }

        /*
         * Set Title
         * Set Column Width
         * Set Title Color
         * Set Wrap Test
         * Set Alignment
         * 
         * */
        private void initExcelFormat(Excel.Worksheet Ws) {
            Ws.Cells[1, FindingListItemOrder.ITEMNUM] = @"#";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.ITEMNUM]).ColumnWidth = 3;

            Ws.Cells[1, FindingListItemOrder.APPLICATIONNAME] = @"Application Name";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.APPLICATIONNAME]).ColumnWidth = 25;

            Ws.Cells[1, FindingListItemOrder.FINDINGNAME] = @"Finding Name";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.FINDINGNAME]).ColumnWidth = 25;

            Ws.Cells[1, FindingListItemOrder.GENERALNAME] = @"General Name";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.GENERALNAME]).ColumnWidth = 25;

            Ws.Cells[1, FindingListItemOrder.OWASP] = @"OWASP";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.OWASP]).ColumnWidth = 18;

            Ws.Cells[1, FindingListItemOrder.RISKLEVEL] = @"Risk Level";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.RISKLEVEL]).ColumnWidth = 18;

            Ws.Cells[1, FindingListItemOrder.AFFECTED] = @"Affected";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.AFFECTED]).ColumnWidth = 40;

            Ws.Cells[1, FindingListItemOrder.DESCRIPTION] = @"Description";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.DESCRIPTION]).ColumnWidth = 50;

            Ws.Cells[1, FindingListItemOrder.RECOMMENDATION] = @"Recommendation";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.RECOMMENDATION]).ColumnWidth = 50;

            Ws.Cells[1, FindingListItemOrder.NOTES] = @"Notes";
            ((Excel.Range)Ws.Columns[FindingListItemOrder.NOTES]).ColumnWidth = 30;

            ((Excel.Range)Ws.Columns["A:J"]).WrapText = true;
            ((Excel.Range)Ws.Columns["A:J"]).HorizontalAlignment = Excel.XlHAlign.xlHAlignLeft;
            ((Excel.Range)Ws.Columns["A:J"]).VerticalAlignment = Excel.XlVAlign.xlVAlignTop;
         
            Ws.Range["A1", "J1"].Interior.Color = System.Drawing.ColorTranslator.ToOle(System.Drawing.Color.LightSkyBlue);
        }



        // Add Item
        private void addItem(DataEntry entry, int position) {
            Ws.Cells[position, FindingListItemOrder.ITEMNUM] = position - 1;
            Ws.Cells[position, FindingListItemOrder.APPLICATIONNAME] = entry.getApplicationName();
            Ws.Cells[position, FindingListItemOrder.FINDINGNAME] = entry.getFindingName();
            Ws.Cells[position, FindingListItemOrder.GENERALNAME] = entry.getGeneralName();
            Ws.Cells[position, FindingListItemOrder.OWASP] = entry.getOWASPString();
            Ws.Cells[position, FindingListItemOrder.RISKLEVEL] = entry.getRiskLevel().ToString();
            Ws.Cells[position, FindingListItemOrder.AFFECTED] = entry.getAffected();
            Ws.Cells[position, FindingListItemOrder.DESCRIPTION] = entry.getDetails();
            Ws.Cells[position, FindingListItemOrder.RECOMMENDATION] = entry.getRecommendation();
            Ws.Cells[position, FindingListItemOrder.NOTES] = entry.getNotes();
        }

        public void insertFindings(ProjectFindings projectFindings) {

            Dictionary<string, ApplicationFindings> applicationFindingList = projectFindings.getApplicationFindingList();
            
            foreach (string appName in applicationFindingList.Keys) {
                ApplicationFindings pentestFindings = applicationFindingList[appName];

                List<DataEntry> highRiskList = pentestFindings.getHighRisk();
                List<DataEntry> mediumRiskList = pentestFindings.getMediumRisk();
                List<DataEntry> LowRiskList = pentestFindings.getLowRisk();
                List<DataEntry> AOIList = pentestFindings.getInformational();
                
                foreach (DataEntry entry in highRiskList) {
                    addItem(entry, numOfItems++);
                }
                foreach (DataEntry entry in mediumRiskList) {
                    addItem(entry, numOfItems++);
                }
                foreach (DataEntry entry in LowRiskList) {
                    addItem(entry, numOfItems++);
                }
                foreach (DataEntry entry in AOIList) {
                    addItem(entry, numOfItems++);
                }

            }

            foreach (string appName in applicationFindingList.Keys) {
                ApplicationFindings pentestFindings = applicationFindingList[appName];

                List<DataEntry> unclassifiedList = pentestFindings.getUnclassified();

                foreach (DataEntry entry in unclassifiedList) {
                    addItem(entry, numOfItems++);
                }
            }
            
        }
        
    }
}
