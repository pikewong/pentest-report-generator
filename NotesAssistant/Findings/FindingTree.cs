using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace NotesAssistant.Findings {
    
    class FindingTree {
        TreeView tv = null;

        TreeNode selectedNode = null;
        TreeNode selectedRootNode = null;
        RiskLevel selectedNodeRiskLevel = RiskLevel.Unclassified;

        public FindingTree(TreeView treeview) {
            this.tv = treeview;
            tv.ExpandAll();
        }

        /// <summary>
        /// Record which finding is editing
        /// </summary>
        /// <param name="node"></param>
        public void setSelectedNode(TreeNode node) {
            selectedNode = node;
            if (selectedNode == null) return;

            selectedRootNode = node;
            while (selectedRootNode.Parent != null) selectedRootNode = selectedRootNode.Parent;
            if (selectedNode == selectedRootNode) {
                selectedNode = null;
                return;
            } 

            TreeNode tempNode = selectedNode;
            if (tempNode.Parent.Text == @"High Risk") selectedNodeRiskLevel = RiskLevel.High;
            else if (tempNode.Parent.Text == @"Medium Risk") selectedNodeRiskLevel = RiskLevel.Medium;
            else if (tempNode.Parent.Text == @"Low Risk") selectedNodeRiskLevel = RiskLevel.Low;
            else if (tempNode.Parent.Text == @"Informational") selectedNodeRiskLevel = RiskLevel.Informational;
            else selectedNodeRiskLevel = RiskLevel.Unclassified;
        }

        public bool isFindingSelected() {
            return (selectedNode != null);
        }

        public string getSelectedFindingName() {
            return selectedNode.Text;
        }

        public string getSelectedRootNodeName() {
            return selectedRootNode.Text;
        }

        public RiskLevel getSelecetedFindingRisk() {
            return selectedNodeRiskLevel;
        }


        public TreeNode createTreeNode(string name) {
            TreeNode node = new TreeNode();
            node.Name = name;
            node.Text = name;
            return node;
        }

        public void addApplication(string applicationName) {
            TreeNode rootNode = createTreeNode(applicationName);
            TreeNode highRiskNode = createTreeNode(@"High Risk");
            TreeNode mediumRiskNode = createTreeNode(@"Medium Risk");
            TreeNode lowRiskNode = createTreeNode(@"Low Risk");
            TreeNode informationalNode = createTreeNode(@"Informational");
            TreeNode unclassifiedNode = createTreeNode(@"Unclassified");

            tv.Nodes.Add(rootNode);
            tv.Nodes[applicationName].Nodes.Add(highRiskNode);
            tv.Nodes[applicationName].Nodes.Add(mediumRiskNode);
            tv.Nodes[applicationName].Nodes.Add(lowRiskNode);
            tv.Nodes[applicationName].Nodes.Add(informationalNode);
            tv.Nodes[applicationName].Nodes.Add(unclassifiedNode);
            tv.ExpandAll();
        }

        public void removeApplication(string applicationName) {
            tv.Nodes[applicationName].Remove();
        }

        public void insertFinding(string applicationName, string findingName, RiskLevel riskLevel){
            TreeNode applicationNode = tv.Nodes[applicationName];
            TreeNode newNode = new TreeNode();
            newNode.Text = findingName;
            newNode.Name = findingName;
            if (riskLevel == RiskLevel.High) {
                applicationNode.Nodes[@"High Risk"].Nodes.Add(newNode);
            }
            else if (riskLevel == RiskLevel.Medium) {
                applicationNode.Nodes[@"Medium Risk"].Nodes.Add(newNode);
            }
            else if (riskLevel == RiskLevel.Low) {
                applicationNode.Nodes[@"Low Risk"].Nodes.Add(newNode);
            }
            else if (riskLevel == RiskLevel.Informational) {
                applicationNode.Nodes[@"Informational"].Nodes.Add(newNode);
            }
            else if (riskLevel == RiskLevel.Unclassified) {
                applicationNode.Nodes[@"Unclassified"].Nodes.Add(newNode);
            }

            // Set Focus on this node when added
            if (Program.state.formStartState != State.FormState.OPEN) {
                tv.SelectedNode = newNode;
                applicationNode.ExpandAll();
                setSelectedNode(newNode);
            }
        }

        public void removeFinding(string applicationName, string findingName, RiskLevel riskLevel) {
            TreeNode applicationNode = tv.Nodes[applicationName];
            if (riskLevel == RiskLevel.High) {
                applicationNode.Nodes[@"High Risk"].Nodes[findingName].Remove();
            }
            else if (riskLevel == RiskLevel.Medium) {
                applicationNode.Nodes[@"Medium Risk"].Nodes[findingName].Remove();
            }
            else if (riskLevel == RiskLevel.Low) {
                applicationNode.Nodes[@"Low Risk"].Nodes[findingName].Remove();
            }
            else if (riskLevel == RiskLevel.Informational) {
                applicationNode.Nodes[@"Informational"].Nodes[findingName].Remove();
            }
            else if (riskLevel == RiskLevel.Unclassified) {
                applicationNode.Nodes[@"Unclassified"].Nodes[findingName].Remove();
            }
        }

    }
}
